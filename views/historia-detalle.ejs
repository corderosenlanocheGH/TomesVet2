<%- include('partials/head', { title: 'Detalle historia clínica | TomesVet' }) %>
<%
  const formatShortDate = (value = '') => {
    if (!value) return '-';
    const normalized = value.toString().split('T')[0];
    const [year, month, day] = normalized.split('-');
    if (year && month && day) {
      return `${day}/${month}/${year}`;
    }
    const parsed = new Date(value);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toLocaleDateString('es-AR');
    }
    return value;
  };

  const showValue = (value) => value || '-';
%>
<%- include('partials/nav') %>

<main class="content-area">
  <div class="row g-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
            <h4 class="card-title mb-0">Detalle de historia clínica</h4>
            <div class="d-flex gap-2">
              <a class="btn btn-outline-primary" href="/historia-clinica/<%= historia.id %>/imprimir" target="_blank" rel="noopener noreferrer">Generar PDF</a>
              <a class="btn btn-outline-secondary" href="/historia-clinica">Volver al listado</a>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
              <tbody>
                <tr><th style="width: 30%">Mascota</th><td><%= historia.mascota_nombre %></td></tr>
                <tr><th>Especie</th><td><%= showValue(historia.mascota_especie) %></td></tr>
                <tr><th>Raza</th><td><%= showValue(historia.mascota_raza) %></td></tr>
                <tr><th>Sexo</th><td><%= showValue(historia.mascota_sexo) %></td></tr>
                <tr><th>Tamaño</th><td><%= showValue(historia.mascota_tamanio) %></td></tr>
                <tr><th>Fecha</th><td><%= formatShortDate(historia.fecha) %></td></tr>
                <tr><th>Motivo</th><td><%= showValue(historia.motivo) %></td></tr>
                <tr><th>Aspecto general</th><td><%= showValue(historia.aspecto_general) %></td></tr>
                <tr><th>Estado de nutrición</th><td><%= showValue(historia.estado_nutricion) %></td></tr>
                <tr><th>Última desparacitación</th><td><%= formatShortDate(historia.ultima_desparacitacion) %></td></tr>
                <tr>
                  <th>Parámetros</th>
                  <td>
                    FC: <%= showValue(historia.frecuencia_cardiaca) %><br />
                    FR: <%= showValue(historia.frecuencia_respiratoria) %><br />
                    Hidratación: <%= showValue(historia.hidratacion) %><br />
                    Temperatura: <%= showValue(historia.temperatura) %>
                  </td>
                </tr>
                <tr>
                  <th>Estado de mucosa</th>
                  <td>
                    Palpebral: <%= showValue(historia.mucosa_palpebral) %><br />
                    Escleral: <%= showValue(historia.mucosa_escleral) %><br />
                    Bucal: <%= showValue(historia.mucosa_bucal) %><br />
                    Vul/Pen: <%= showValue(historia.mucosa_vulpen) %>
                  </td>
                </tr>
                <tr><th>Diagnóstico presuntivo</th><td><%= showValue(historia.diagnostico_presuntivo) %></td></tr>
                <tr><th>Diagnóstico diferencial</th><td><%= showValue(historia.diagnostico_diferencial) %></td></tr>
                <tr><th>Diagnóstico definitivo</th><td><%= showValue(historia.diagnostico_definitivo) %></td></tr>
                <tr><th>Análisis solicitados</th><td><%= showValue(historia.analisis_solicitados) %></td></tr>
                <tr><th>Tratamiento y medicación</th><td><%= showValue(historia.tratamiento) %></td></tr>
                <tr><th>Otros Datos</th><td><%= showValue(historia.otros_datos) %></td></tr>
                <tr>
                  <th>Documentación adjunta</th>
                  <td>
                    <% if (documentos && documentos.length) { %>
                      <div class="d-grid gap-3">
                        <% documentos.forEach((documento) => { %>
                          <div class="border rounded p-2">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                              <strong><%= documento.nombre_original %></strong>
                              <a
                                class="btn btn-sm btn-outline-primary"
                                href="<%= documento.ruta_publica %>"
                                target="_blank"
                                rel="noopener noreferrer"
                              >
                                Ver PDF
                              </a>
                            </div>
                            <iframe
                              src="<%= documento.ruta_publica %>"
                              title="Documentación adjunta"
                              width="100%"
                              height="380"
                              class="border rounded"
                            ></iframe>
                          </div>
                        <% }) %>
                      </div>
                    <% } else { %>
                      -
                    <% } %>

                    <form
                      action="/historia-clinica/<%= historia.id %>/documentos"
                      method="POST"
                      class="mt-3 d-grid gap-2"
                      id="historia-documento-form"
                    >
                      <label class="form-label mb-0">Agregar documentación adjunta (PDF)</label>
                      <input
                        class="form-control"
                        type="file"
                        name="documentacion_adjunta"
                        id="historia-documento-adjunta"
                        accept="application/pdf,.pdf"
                        required
                      />
                      <input
                        type="hidden"
                        name="documentacion_adjunta_nombre"
                        id="historia-documento-adjunta-nombre"
                      />
                      <input
                        type="hidden"
                        name="documentacion_adjunta_base64"
                        id="historia-documento-adjunta-base64"
                      />
                      <div>
                        <button class="btn btn-sm btn-primary" type="submit">Agregar PDF</button>
                      </div>
                    </form>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const historiaDocumentoForm = document.getElementById('historia-documento-form');
  const historiaDocumentoInput = document.getElementById('historia-documento-adjunta');
  const historiaDocumentoNombre = document.getElementById('historia-documento-adjunta-nombre');
  const historiaDocumentoBase64 = document.getElementById('historia-documento-adjunta-base64');

  if (historiaDocumentoForm && historiaDocumentoInput && historiaDocumentoNombre && historiaDocumentoBase64) {
    historiaDocumentoForm.addEventListener('submit', async (event) => {
      const [file] = historiaDocumentoInput.files || [];
      if (!file) return;

      if (file.type !== 'application/pdf' || !file.name.toLowerCase().endsWith('.pdf')) {
        event.preventDefault();
        alert('La documentación adjunta debe ser un archivo PDF válido.');
        return;
      }

      event.preventDefault();

      const encodedFile = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('No se pudo leer el archivo adjunto.'));
        reader.readAsDataURL(file);
      });

      historiaDocumentoNombre.value = file.name;
      historiaDocumentoBase64.value = encodedFile;
      historiaDocumentoForm.submit();
    });
  }
</script>

<%- include('partials/footer') %>
