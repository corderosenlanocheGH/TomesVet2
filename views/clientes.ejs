<%- include('partials/head', { title: 'Clientes | TomesVet' }) %>
<%- include('partials/nav') %>

<main class="content-area">
  <div class="row g-4">
    <% if (showForm) { %>
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h4 class="card-title mb-3">
              <%= clienteEditar ? 'Editar cliente' : 'Nuevo cliente' %>
            </h4>
            <form
              action="<%= clienteEditar ? `/clientes/${clienteEditar.id}` : '/clientes' %>"
              method="POST"
              class="d-grid gap-3"
            >
              <div>
                <label class="form-label">Nombre completo</label>
                <input
                  class="form-control"
                  type="text"
                  name="nombre"
                  value="<%= clienteEditar ? clienteEditar.nombre : '' %>"
                  required
                />
              </div>
              <div>
                <label class="form-label">Teléfono</label>
                <input
                  class="form-control"
                  type="text"
                  name="telefono"
                  value="<%= clienteEditar ? clienteEditar.telefono : '' %>"
                  required
                />
              </div>
              <div>
                <label class="form-label">Email</label>
                <input
                  class="form-control"
                  type="email"
                  name="email"
                  value="<%= clienteEditar ? clienteEditar.email || '' : '' %>"
                />
              </div>
              <div>
                <label class="form-label">Dirección</label>
                <input
                  class="form-control"
                  type="text"
                  name="direccion"
                  value="<%= clienteEditar ? clienteEditar.direccion || '' : '' %>"
                />
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary" type="submit">
                  <%= clienteEditar ? 'Actualizar' : 'Guardar' %>
                </button>
                <a class="btn btn-outline-secondary" href="/clientes">Cancelar</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    <% } %>
    <div class="<%= showForm ? 'col-lg-8' : 'col-12' %>">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <h4 class="card-title mb-0">Clientes</h4>
            <a class="btn btn-primary" href="/clientes?nuevo=1">Nuevo cliente</a>
          </div>
          <div class="row g-3 turnos-filters mb-3">
            <div class="col-md-4">
              <label class="filters-label" for="clientes-busqueda">Buscar</label>
              <input
                class="form-control"
                id="clientes-busqueda"
                type="search"
                placeholder="Cliente, teléfono o email"
              />
            </div>
            <div class="col-md-4">
              <label class="filters-label" for="clientes-mascota">Mascota</label>
              <select class="form-select" id="clientes-mascota">
                <option value="">Todas</option>
                <% mascotas.forEach((mascota) => { %>
                  <option
                    value="<%= mascota.id %>"
                    <%= selectedMascotaId === String(mascota.id) ? 'selected' : '' %>
                  >
                    <%= mascota.nombre %> · <%= mascota.cliente_nombre %>
                  </option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100" type="button" id="clientes-limpiar">
                Limpiar
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Teléfono</th>
                  <th>Email</th>
                  <th>Dirección</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="clientes-body">
                <% clientes.forEach((cliente) => { %>
                  <tr data-cliente-id="<%= cliente.id %>">
                    <td><%= cliente.nombre %></td>
                    <td><%= cliente.telefono %></td>
                    <td><%= cliente.email || '-' %></td>
                    <td><%= cliente.direccion || '-' %></td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-outline-primary" href="/clientes?editar=<%= cliente.id %>">
                          Editar
                        </a>
                        <a class="btn btn-outline-secondary" href="/mascotas?cliente_id=<%= cliente.id %>">
                          Ver mascotas
                        </a>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const normalizeText = (value = '') =>
    value
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();

  const clientesBody = document.getElementById('clientes-body');
  const clientesRows = Array.from(clientesBody?.querySelectorAll('tr') || []);
  const clientesBusqueda = document.getElementById('clientes-busqueda');
  const clientesMascota = document.getElementById('clientes-mascota');
  const clientesLimpiar = document.getElementById('clientes-limpiar');
  const mascotasClienteMap = <%- JSON.stringify(
    mascotas.reduce((acc, mascota) => {
      const clienteId = String(mascota.cliente_id);
      if (!acc[clienteId]) {
        acc[clienteId] = [];
      }
      acc[clienteId].push(String(mascota.id));
      return acc;
    }, {})
  ) %>;

  const applyClientesFilter = () => {
    const query = normalizeText(clientesBusqueda.value);
    const mascotaId = clientesMascota.value;

    clientesRows.forEach((row) => {
      const clienteId = row.dataset.clienteId || '';
      const rowText = normalizeText(row.textContent);
      const textMatch = !query || rowText.includes(query);
      const mascotaMatch = !mascotaId || (mascotasClienteMap[clienteId] || []).includes(mascotaId);
      row.classList.toggle('is-hidden', !(textMatch && mascotaMatch));
    });
  };

  const clearClientesFilter = () => {
    clientesBusqueda.value = '';
    clientesMascota.value = '';
    applyClientesFilter();
  };

  clientesBusqueda.addEventListener('input', applyClientesFilter);
  clientesMascota.addEventListener('change', applyClientesFilter);
  clientesLimpiar.addEventListener('click', clearClientesFilter);

  applyClientesFilter();
</script>

<%- include('partials/footer') %>
