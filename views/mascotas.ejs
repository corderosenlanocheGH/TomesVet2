<%- include('partials/head', { title: 'Mascotas | TomesVet' }) %>
<%
  const formatInputDate = (value = '') => {
    if (!value) return '';
    const normalized = value.toString().split('T')[0];
    if (/^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
      return normalized;
    }
    const parsed = new Date(value);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toISOString().slice(0, 10);
    }
    return '';
  };
  const formatShortDate = (value = '') => {
    if (!value) return '';
    const normalized = value.toString().split('T')[0];
    const [year, month, day] = normalized.split('-');
    if (year && month && day) {
      return `${day}/${month}/${year}`;
    }
    const parsed = new Date(value);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toLocaleDateString('es-AR');
    }
    return value;
  };
%>
<%- include('partials/nav') %>

<main class="content-area">
  <div class="row g-4">
    <% if (showForm) { %>
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h4 class="card-title mb-3">
              <%= mascotaEditar ? 'Editar mascota' : 'Nueva mascota' %>
            </h4>
            <form
              action="<%= mascotaEditar ? `/mascotas/${mascotaEditar.id}` : '/mascotas' %>"
              method="POST"
              class="d-grid gap-3"
            >
              <div>
                <label class="form-label">Nombre</label>
                <input
                  class="form-control"
                  type="text"
                  name="nombre"
                  value="<%= mascotaEditar ? mascotaEditar.nombre : '' %>"
                  required
                />
              </div>
              <div>
                <label class="form-label">Especie</label>
                <select class="form-select" name="especie" id="mascota-especie" required>
                  <option value="" disabled <%= mascotaEditar ? '' : 'selected' %>>
                    Selecciona una especie
                  </option>
                  <% especiesMascota.forEach((especie) => { %>
                    <option
                      value="<%= especie.nombre %>"
                      <%= mascotaEditar && mascotaEditar.especie === especie.nombre ? 'selected' : '' %>
                    >
                      <%= especie.nombre %>
                    </option>
                  <% }) %>
                  <% if (mascotaEditar && mascotaEditar.especie && !especiesMascota.some((especie) => especie.nombre === mascotaEditar.especie)) { %>
                    <option value="<%= mascotaEditar.especie %>" selected>
                      <%= mascotaEditar.especie %> (actual)
                    </option>
                  <% } %>
                </select>
              </div>
              <div>
                <label class="form-label">Raza</label>
                <select class="form-select" name="raza" id="mascota-raza">
                  <option value="" <%= mascotaEditar && mascotaEditar.raza ? '' : 'selected' %>>
                    Selecciona una raza
                  </option>
                  <% razasMascota.forEach((raza) => { %>
                    <option
                      value="<%= raza.nombre %>"
                      data-especie-id="<%= raza.especie_id || '' %>"
                      data-especie-nombre="<%= raza.especie_nombre || '' %>"
                      <%= mascotaEditar && mascotaEditar.raza === raza.nombre ? 'selected' : '' %>
                    >
                      <%= raza.nombre %>
                    </option>
                  <% }) %>
                  <% if (mascotaEditar && mascotaEditar.raza && !razasMascota.some((raza) => raza.nombre === mascotaEditar.raza)) { %>
                    <option value="<%= mascotaEditar.raza %>" selected>
                      <%= mascotaEditar.raza %> (actual)
                    </option>
                  <% } %>
                </select>
              </div>
              <div>
                <label class="form-label">Sexo</label>
                <select class="form-select" name="sexo" required>
                  <option value="" disabled <%= mascotaEditar ? '' : 'selected' %>>
                    Selecciona el sexo
                  </option>
                  <% sexosMascota.forEach((sexoOpcion) => { %>
                    <option
                      value="<%= sexoOpcion %>"
                      <%= mascotaEditar && mascotaEditar.sexo === sexoOpcion ? 'selected' : '' %>
                    >
                      <%= sexoOpcion %>
                    </option>
                  <% }) %>
                </select>
              </div>
              <div>
                <label class="form-label">Tamaño</label>
                <select class="form-select" name="tamanio" required>
                  <option value="" disabled <%= mascotaEditar ? '' : 'selected' %>>
                    Selecciona un tamaño
                  </option>
                  <% tamaniosMascota.forEach((tamanioOpcion) => { %>
                    <option
                      value="<%= tamanioOpcion %>"
                      <%= mascotaEditar && mascotaEditar.tamanio === tamanioOpcion ? 'selected' : '' %>
                    >
                      <%= tamanioOpcion %>
                    </option>
                  <% }) %>
                </select>
              </div>
              <div>
                <label class="form-label">Color</label>
                <input
                  class="form-control"
                  type="text"
                  name="color"
                  value="<%= mascotaEditar ? (mascotaEditar.color || '') : '' %>"
                />
              </div>
              <div>
                <label class="form-label">Señas particulares</label>
                <textarea class="form-control" name="senias_particulares" rows="2"><%= mascotaEditar ? (mascotaEditar.senias_particulares || '') : '' %></textarea>
              </div>
              <div>
                <label class="form-label">Fecha de nacimiento</label>
                <input
                  class="form-control"
                  type="date"
                  name="fecha_nacimiento"
                  value="<%= mascotaEditar ? formatInputDate(mascotaEditar.fecha_nacimiento) : '' %>"
                />
              </div>
              <div>
                <label class="form-label">Cliente</label>
                <select class="form-select" name="cliente_id" required>
                  <option value="" disabled selected>Selecciona un cliente</option>
                  <% clientes.forEach((cliente) => { %>
                    <option
                      value="<%= cliente.id %>"
                      <%= mascotaEditar && mascotaEditar.cliente_id === cliente.id ? 'selected' : '' %>
                    >
                      <%= cliente.nombre %>
                    </option>
                  <% }) %>
                </select>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary" type="submit">
                  <%= mascotaEditar ? 'Actualizar' : 'Guardar' %>
                </button>
                <a class="btn btn-outline-secondary" href="/mascotas">Cancelar</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    <% } %>
    <div class="<%= showForm ? 'col-lg-8' : 'col-12' %>">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <h4 class="card-title mb-0">Mascotas registradas</h4>
            <a class="btn btn-primary" href="/mascotas?nuevo=1">Nueva mascota</a>
          </div>
          <div class="row g-3 turnos-filters mb-3">
            <div class="col-md-4">
              <label class="filters-label" for="mascotas-busqueda">Buscar</label>
              <input
                class="form-control"
                id="mascotas-busqueda"
                type="search"
                placeholder="Mascota, especie o raza"
              />
            </div>
            <div class="col-md-4">
              <label class="filters-label" for="mascotas-cliente">Cliente</label>
              <select class="form-select" id="mascotas-cliente">
                <option value="">Todos</option>
                <% clientes.forEach((cliente) => { %>
                  <option
                    value="<%= cliente.id %>"
                    <%= selectedClienteId === String(cliente.id) ? 'selected' : '' %>
                  >
                    <%= cliente.nombre %>
                  </option>
                <% }) %>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100" type="button" id="mascotas-limpiar">
                Limpiar
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Especie</th>
                  <th>Raza</th>
                  <th>Sexo</th>
                  <th>Tamaño</th>
                  <th>Color</th>
                  <th>Señas particulares</th>
                  <th>Fecha nacimiento</th>
                  <th>Cliente</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="mascotas-body">
                <% mascotas.forEach((mascota) => { %>
                  <tr data-cliente-id="<%= mascota.cliente_id %>">
                    <td><%= mascota.nombre %></td>
                    <td><%= mascota.especie %></td>
                    <td><%= mascota.raza || '-' %></td>
                    <td><%= mascota.sexo || '-' %></td>
                    <td><%= mascota.tamanio || '-' %></td>
                    <td><%= mascota.color || '-' %></td>
                    <td><%= mascota.senias_particulares || '-' %></td>
                    <td><%= formatShortDate(mascota.fecha_nacimiento) || '-' %></td>
                    <td>
                      <a class="link-secondary text-decoration-none" href="/clientes?mascota_id=<%= mascota.id %>">
                        <%= mascota.cliente_nombre %>
                      </a>
                    </td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-outline-primary" href="/mascotas?editar=<%= mascota.id %>">
                          Editar
                        </a>
                        <a class="btn btn-outline-secondary" href="/vacunas?mascota_id=<%= mascota.id %>">
                          Vacunas
                        </a>
                        <a
                          class="btn btn-outline-secondary"
                          href="/historia-clinica?mascota_id=<%= mascota.id %>"
                        >
                          Historia clínica
                        </a>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const normalizeText = (value = '') =>
    value
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();

  const mascotasBody = document.getElementById('mascotas-body');
  const mascotasRows = Array.from(mascotasBody?.querySelectorAll('tr') || []);
  const mascotasBusqueda = document.getElementById('mascotas-busqueda');
  const mascotasCliente = document.getElementById('mascotas-cliente');
  const mascotasLimpiar = document.getElementById('mascotas-limpiar');
  const especieSelect = document.getElementById('mascota-especie');
  const razaSelect = document.getElementById('mascota-raza');

  const syncRazaOptions = () => {
    if (!especieSelect || !razaSelect) {
      return;
    }

    const especieSeleccionada = especieSelect.value;
    let selectedOptionStillVisible = false;

    Array.from(razaSelect.options).forEach((option, index) => {
      if (index === 0) {
        option.hidden = false;
        return;
      }

      const especieNombre = option.dataset.especieNombre || '';
      const shouldShow = !especieSeleccionada || especieNombre === especieSeleccionada;
      option.hidden = !shouldShow;

      if (shouldShow && option.selected) {
        selectedOptionStillVisible = true;
      }
    });

    if (!selectedOptionStillVisible) {
      razaSelect.value = '';
    }
  };

  const applyMascotasFilter = () => {
    const query = normalizeText(mascotasBusqueda.value);
    const clienteId = mascotasCliente.value;

    mascotasRows.forEach((row) => {
      const rowText = normalizeText(row.textContent);
      const rowClienteId = row.dataset.clienteId || '';
      const textMatch = !query || rowText.includes(query);
      const clienteMatch = !clienteId || rowClienteId === clienteId;
      row.classList.toggle('is-hidden', !(textMatch && clienteMatch));
    });
  };

  const clearMascotasFilter = () => {
    mascotasBusqueda.value = '';
    mascotasCliente.value = '';
    applyMascotasFilter();
  };

  mascotasBusqueda.addEventListener('input', applyMascotasFilter);
  mascotasCliente.addEventListener('change', applyMascotasFilter);
  mascotasLimpiar.addEventListener('click', clearMascotasFilter);
  especieSelect?.addEventListener('change', syncRazaOptions);

  applyMascotasFilter();
  syncRazaOptions();
</script>

<%- include('partials/footer') %>
