<%- include('partials/head', { title: 'Próximas vacunas | TomesVet' }) %>
<%
  const formatShortDate = (value = '') => {
    if (!value) return '';
    const normalized = value.toString().split('T')[0];
    const [year, month, day] = normalized.split('-');
    if (year && month && day) {
      return `${day}/${month}/${year}`;
    }
    const parsed = new Date(value);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toLocaleDateString('es-AR');
    }
    return value;
  };

  const sanitizePhoneForWhatsapp = (rawPhone = '') =>
    rawPhone
      .toString()
      .trim()
      .replace(/[^\d]/g, '');
%>
<%- include('partials/nav') %>

<main class="content-area">
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h4 class="card-title mb-1">Próximas vacunas (30 días)</h4>
          <p class="text-muted mb-0">
            Mascotas con fecha de próxima vacuna dentro de un mes.
          </p>
        </div>
        <a class="btn btn-outline-primary" href="/vacunas">Ver historial de vacunas</a>
      </div>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Fecha próxima</th>
              <th>Mascota</th>
              <th>Cliente</th>
              <th>Vacuna</th>
              <th>Teléfono</th>
              <th>Enviado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% if (!recordatorios.length) { %>
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No hay próximas vacunas dentro de los próximos 30 días.
                </td>
              </tr>
            <% } %>

            <% recordatorios.forEach((recordatorio) => {
              const phoneSanitized = sanitizePhoneForWhatsapp(recordatorio.cliente_telefono);
              const whatsappMessage = encodeURIComponent(`Hola ${recordatorio.cliente_nombre}, te recordamos la próxima vacuna de ${recordatorio.mascota_nombre} (${recordatorio.nombre_comercial} - ${recordatorio.tipo}) para el día ${formatShortDate(recordatorio.proxima_fecha_aplicacion)}.`);
              const whatsappUrl = phoneSanitized
                ? `https://wa.me/${phoneSanitized}?text=${whatsappMessage}`
                : '';
            %>
              <tr>
                <td><%= formatShortDate(recordatorio.proxima_fecha_aplicacion) %></td>
                <td><%= recordatorio.mascota_nombre %></td>
                <td><%= recordatorio.cliente_nombre %></td>
                <td><%= recordatorio.nombre_comercial %> · <%= recordatorio.tipo %></td>
                <td><%= recordatorio.cliente_telefono || '-' %></td>
                <td>
                  <form
                    action="/vacunas/<%= recordatorio.id %>/recordatorio-whatsapp"
                    method="POST"
                    class="d-inline-flex align-items-center"
                  >
                    <input
                      type="hidden"
                      name="recordatorio_whatsapp_enviado"
                      value="<%= recordatorio.recordatorio_whatsapp_enviado ? '1' : '0' %>"
                    />
                    <input
                      class="form-check-input reminder-checkbox"
                      type="checkbox"
                      aria-label="Recordatorio WhatsApp enviado"
                      <%= recordatorio.recordatorio_whatsapp_enviado ? 'checked' : '' %>
                    />
                  </form>
                </td>
                <td class="text-end">
                  <% if (whatsappUrl) { %>
                    <a
                      class="btn btn-sm btn-success whatsapp-send-btn"
                      href="<%= whatsappUrl %>"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      <i class="bi bi-whatsapp"></i>
                      Enviar WhatsApp
                    </a>
                  <% } else { %>
                    <span class="text-muted small">Sin número válido</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>

<script>
  document.querySelectorAll('.reminder-checkbox').forEach((checkbox) => {
    checkbox.addEventListener('change', () => {
      const form = checkbox.closest('form');
      const hiddenInput = form.querySelector('input[name="recordatorio_whatsapp_enviado"]');
      hiddenInput.value = checkbox.checked ? '1' : '0';
      form.submit();
    });
  });

  document.querySelectorAll('.whatsapp-send-btn').forEach((button) => {
    button.addEventListener('click', () => {
      const row = button.closest('tr');
      const checkbox = row.querySelector('.reminder-checkbox');
      if (!checkbox || checkbox.checked) {
        return;
      }

      const form = checkbox.closest('form');
      const hiddenInput = form.querySelector('input[name="recordatorio_whatsapp_enviado"]');
      checkbox.checked = true;
      hiddenInput.value = '1';
      form.submit();
    });
  });
</script>
